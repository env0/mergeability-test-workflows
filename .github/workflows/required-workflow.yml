name: Required Workflow (Cross-Repo)

on:
  workflow_call:
  pull_request:
    types: [opened, synchronize, labeled, unlabeled]

jobs:
  # Shared delay gate - when 'delay-checks' label is present, sleeps ~30s so that
  # dependent jobs' CheckRuns are created later (pushing them to page 2+ in GraphQL pagination)
  delay-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Delay if label present
        if: contains(github.event.pull_request.labels.*.name, 'delay-checks')
        run: |
          echo "Delaying ~30 seconds due to 'delay-checks' label"
          sleep 30
      - name: No delay
        if: ${{ !contains(github.event.pull_request.labels.*.name, 'delay-checks') }}
        run: echo "No delay label, proceeding immediately"

  required-check:
    needs: [delay-gate]
    runs-on: ubuntu-latest
    steps:
      - name: Check for fail label
        if: contains(github.event.pull_request.labels.*.name, 'fail-required-workflow')
        run: |
          echo "Failing due to 'fail-required-workflow' label"
          exit 1
      - name: Check for pending label
        if: contains(github.event.pull_request.labels.*.name, 'pending-required-workflow')
        run: |
          echo "Staying pending due to 'pending-required-workflow' label"
          sleep 3600
      - name: Pass
        run: echo "Required workflow from env0/mergeability-test-workflows passed"
